{% load staticfiles %}
<script src="{% static "lib/js/bootstrap-datetimepicker.min.js" %}" type="text/javascript"></script>
<!--<script src="{% static "lib/js/bootstrap-treeview.min.js" %}" type="text/javascript"></script>-->
<script src="{% static "lib/js/bootstrap-tokenfield.min.js" %}" type="text/javascript"></script>
<!--<script src="{% static "lib/js/bootstrap-multiselect.js" %}" type="text/javascript"></script>-->
<!--<script src="{% static "lib/js/jquery.tree-multiselect.min.js" %}" type="text/javascript"></script>-->
<script src="{% static "lib/js/fastselect.standalone.min.js" %}" type="text/javascript"></script>
<script type="text/javascript">
{% autoescape off %}
    $(function() {
      var pickerOptions = {
          format: 'YYYY-MM-DD hh:mm A',
          pickDate: true,
          pickTime: true,
          language: 'en',
          icons: {
              time: 'fa fa-clock-o',
              date: 'fa fa-calendar',
              up: 'fa fa-chevron-up',
              down: 'fa fa-chevron-down'
          }
      };
      $('#id_resource-date_picker').datetimepicker(pickerOptions);
      $('#id_resource-temporal_extent_start_picker').datetimepicker(pickerOptions);
      $('#id_resource-temporal_extent_end_picker').datetimepicker(pickerOptions);
    });

    $('.modal-forms').css('max-height', '500px').css('overflow-y', 'scroll');    
    $('.modal-cloose-btn').css('margin','20px');

    $('.modal-cloose-btn').click(function(){
      $('.modal-forms').modal('hide');
    });

    $('#id_resource-poc').change(function(){
      if($(this).val() === ''){
        $('#poc_form').modal();
      }
    });

		function getPrevTab(){
            var activeTab = $("ul#md_tabs li.active");
            if (activeTab && activeTab[0].id === 'second') {
                var prevTab = $("ul#md_tabs li#first");
                if (prevTab && prevTab.children()) {
                	prevTab.children().trigger("click");
 				}
            }

            if (activeTab && activeTab[0].id === 'last') {
                var prevTab = $("ul#md_tabs li#second");
                if (prevTab && prevTab.children()) {
                	prevTab.children().trigger("click");
 				}
            }
		};

		function getNextTab(){
            var activeTab = $("ul#md_tabs li.active");
            if (activeTab && activeTab[0].id === 'first') {
                var nextTab = $("ul#md_tabs li#second");
                if (nextTab && nextTab.children()) {
                	nextTab.children().trigger("click");
 				}
            }

            if (activeTab && activeTab[0].id === 'second') {
                var nextTab = $("ul#md_tabs li#last");
                if (nextTab && nextTab.children()) {
                	nextTab.children().trigger("click");
 				}
            }
		};

    $(document).ready(function() {
        $('.has-external-popover').each(function(){
            var help_text = $(this).attr("data-content");
            $(this)
                .parent()
                .children("span")
                .append("<span class='external-popover' data-content='" + help_text + "'><strong><i class='fa fa fa-question-circle fa-1x'></i></strong></span>");
            });
        $('.external-popover').each(function(){
            $(this).popover({'trigger':'hover'});
        });
    });
    
    $(document).ready(function() {
        $('#mdinfo').find(":input").each(function(){
            $(this).change(function(e){
                if(e.target.value.trim() === ''){
                    if(!$(e.target).hasClass("input-empty")){
                        $(e.target).addClass("input-empty");
                        $(e.target).parent().append("<p class='xxs-font-size mandatory-warning'>&nbsp;&nbsp;&nbsp;<strong>* ISO mandatory field</strong></p>");
                    }
                }
                else{
                    $(e.target).removeClass("input-empty");
                    $(e.target).parent().find(".mandatory-warning").remove();
                }    
            }).change();
        });

        $('#btn_back_up').click(function(){getPrevTab()});
        $('#btn_back_dwn').click(function(){getPrevTab()});

        $('#btn_next_up').click(function(){getNextTab()});
        $('#btn_next_dwn').click(function(){getNextTab()});
    });

    $('#id_resource-metadata_author').change(function(){
      if($(this).val() === ''){
        $('#metadata_form').modal();
      }
    });

    $(document).ready(function() {
        {% if layer.metadata_uploaded_preserve %}
        $('#layer_metadata_update :input').attr('readonly','readonly');
        {% endif %}
        $('.has-popover').popover({'trigger':'hover'});

        var params = typeof FILTER_TYPE == 'undefined' ? {} : {'type': FILTER_TYPE};
        $.ajax('/h_keywords_api', {params: params}).success(function(data){
            /*$('#treeview').treeview({
                data: data,
                levels: 1,
                onNodeSelected: function($event, $data) {
                    //TODO: This seems a horribly inelegant way of doing this in 12 Lines
                    kws = $('#id_resource-keywords').tokenfield('getTokens');
                    newToken = $data.text
                    exists = false 
                    for (kw in kws) {
                        if (kws[kw]['value'].indexOf(newToken) >=0) {
                            exists = true
                        }
                    }
                    if (!exists) {
                        $('#id_resource-keywords').tokenfield('createToken', $data.text);
                    }
                }
            });*/
            
            data = JSON.parse(data)
            var kws = [];
            for (kw in data) {
                if (data[kw] && data[kw].text) {
				    kws.push(data[kw].text);
                }
            }
		    $('#id_resource-keywords').tokenfield({
		        autocomplete: {
		            source: kws,
		            delay: 100
		        },
		        showAutocompleteOnFocus: true
		    })
        });
    });
{% endautoescape %}
</script>
